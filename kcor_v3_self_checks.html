
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KCOR v3 Slope-Adjustment Diagnostics (Death-Conserving Checks)</title>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  :root {
    --bg: #ffffff;
    --fg: #111111;
    --muted: #555555;
    --callout: #f6f8fa;
    --border: #e5e7eb;
  }
  html, body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    line-height: 1.55;
  }
  .wrap {
    max-width: 880px;
    padding: 40px 20px 80px;
    margin: 0 auto;
  }
  h1, h2, h3 { line-height: 1.2; margin: 1.2em 0 0.5em; }
  h1 { font-size: 1.9rem; }
  h2 { font-size: 1.35rem; margin-top: 2rem; }
  h3 { font-size: 1.05rem; margin-top: 1.2rem; }
  p { margin: 0.7rem 0; }
  ul, ol { margin: 0.6rem 0 1rem 1.25rem; }
  code, pre, kbd, samp {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.95em;
  }
  pre {
    background: var(--callout);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    overflow: auto;
  }
  .callout {
    background: var(--callout);
    border-left: 4px solid #d1d5db;
    padding: 12px 14px;
    border-radius: 6px;
    margin: 1rem 0;
  }
  .muted { color: var(--muted); }
  hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
  .checklist li { margin-bottom: 0.4rem; }
</style>
</head>
<body>
  <main class="wrap">
    <h1>KCOR v3 Slope-Adjustment Diagnostics</h1>
    <p class="muted">Death-conserving checks &amp; implementation sanity tests.</p>

    <div class="callout">
      <strong>Key premise:</strong> Slope adjustment redistributes deaths over time within each cohort to neutralize baseline slope differences; it must not change totals. For each cohort \(i\):<br/>
      \[ \sum_t D_i'(t) \;=\; \sum_t D_i(t) \]<br/>
      Consequently, population totals are conserved.
    </div>

    <h2>Core invariants (must hold)</h2>
    <ol class="checklist">
      <li><strong>Per-cohort conservation</strong><br/>
        For every cohort \(i\), enforce \( \sum_t D_i'(t) = \sum_t D_i(t) \) within a tiny tolerance \( \epsilon \) (e.g., \(10^{-9}\) of cohort total or &lt; 0.5 death if counts).<br/>
        If violated, weights likely don’t sum to 1 or mass leaked outside the window.
      </li>
      <li><strong>Population conservation</strong><br/>
        Check \( \sum_i \sum_t D_i'(t) = \sum_i \sum_t D_i(t) \) within \( \epsilon \). Catches indexing/NA issues.
      </li>
      <li><strong>Non-negativity</strong><br/>
        Ensure \( D_i'(t) \geq 0 \) for all \(i,t\). Fractional values are fine post-smoothing; never go negative.
      </li>
      <li><strong>Window integrity</strong><br/>
        No deaths shifted outside \([t_{min}, t_{max}]\). If your kernel touches edges, truncate &amp; renormalize.
      </li>
    </ol>

    <h2>Kernel / weight checks</h2>
    <ol class="checklist">
      <li><strong>Weights sum to 1</strong><br/>
        If \( D_i' = W_i D_i \), each column (or row, depending on convention) of \( W_i \) should sum to 1 after edge renormalization.
      </li>
      <li><strong>Zero-mean effect</strong><br/>
        If slope-flattening, verify \( \sum_t (D_i'(t) - D_i(t)) = 0 \).
      </li>
      <li><strong>No silent rescaling</strong><br/>
        If fitting multiplicative shapes then rescaling, check scalar:<br/>
        \[ \alpha_i \;=\; \frac{\sum_t D_i(t)}{\sum_t \tilde{D}_i(t)} \]
      </li>
    </ol>

    <h2>KCOR-specific checks</h2>
    <ol class="checklist">
      <li><strong>Asymptote sanity</strong>: After neutralization, \(R(t)\) should flatten at long \(t\).</li>
      <li><strong>Leave-one-cohort-out stability</strong>: Removing a cohort should not shift \(R(t)\) much.</li>
      <li><strong>Time-bin robustness</strong>: Different bin widths preserve totals; shapes remain stable.</li>
    </ol>

    <h2>Minimal test harness (pseudocode)</h2>
    <pre><code>for i in cohorts:
    orig = D[i]
    adj  = adjust(D[i], params[i])

    assert abs(adj.sum() - orig.sum()) &lt;= eps(max(1.0, orig.sum()))
    assert (adj &gt;= -1e-12).all()
    assert abs((adj - orig).sum()) &lt;= eps(max(1.0, orig.sum()))

assert abs(sum(adj_all).sum() - sum(orig_all).sum()) &lt;= eps_total
</code></pre>

    <h2>Common failure modes (edge cases that often break conservation)</h2>
    <ul>
      <li><strong>Missing weeks / NA fill</strong>: Forward/back fills can change totals. Prefer zeros with a mask; don’t impute.</li>
      <li><strong>Boundary leakage</strong>: Kernels extending past \(t_{max}\); fix via truncation + renormalization on the remaining support.</li>
      <li><strong>Integer rounding</strong>: Don’t round per-period results until the end (and never before checks).</li>
      <li><strong>Global re-centering</strong>: Post-adjustment centering can subtract a nonzero mean — recheck totals.</li>
    </ul>

    <h2>“Did we do it right?” audit widgets (quick checks)</h2>
    <ul>
      <li><strong>Cohort table</strong>: per cohort — <code>total_before</code>, <code>total_after</code>, <code>Δ</code>, <code>min(D')</code>, <code>#negatives</code>, <code>edge_mass_lost</code>.</li>
      <li><strong>Global line</strong>: total <code>ΣΔ</code> across cohorts.</li>
      <li><strong>KCOR view</strong>: plot \(R(t)\) before/after slope neutralization — adjusted should be flatter with similar long-run level.</li>
    </ul>

    <hr/>
    <p class="muted">Prepared for KCOR v3 workflows. Numerically stable, death-conserving.</p>
  </main>
</body>
</html>
